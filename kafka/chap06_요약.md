# 📚 Kafka 컨슈머 내부 동작 원리와 구현 (7장 상세 요약)



## ✅ 6.1 컨슈머 오프셋 관리

- 컨슈머의 핵심 역할은 **메시지를 어디까지 읽었는지 기억**하는 것.
- 읽은 위치 정보(오프셋)는 **`_consumer_offsets`**라는 내부 토픽에 저장.
- 컨슈머 장애로 중단되었다가 재시작해도 마지막 오프셋부터 이어서 처리 가능.
- 오프셋 정보는 **토픽, 파티션, 컨슈머 그룹** 단위로 관리됨.
- `_consumer_offsets` 토픽의 파티션/복제 수는 `server.properties`에서 설정.
  - `offsets.topic.num.partitions`: 기본 50
  - `offsets.topic.replication.factor`: 기본 3



## ✅ 6.2 그룹 코디네이터

- 컨슈머 그룹은 **그룹 코디네이터**가 파티션 할당과 멤버 상태를 관리.
- 그룹에 컨슈머가 추가/제거되면 **리밸런싱(rebalancing)**이 발생.
- 컨슈머는 하트비트(heartbeat)를 주기적으로 보내 코디네이터가 상태를 확인.
- 불필요한 리밸런싱을 줄이려면 스태틱 멤버십 등을 사용.
- **관련 그림**:  
  - 그림 6-2: 그룹 코디네이터와 컨슈머 관계  
  - 그림 6-3: 컨슈머 그룹 등록 과정



## ✅ 6.3 스태틱 멤버십

- 컨슈머가 재시작될 때 **동일한 ID로 인식**되어 리밸런싱 방지.
- 기본 리밸런싱은 컨슈머 종료 시마다 전체 파티션 할당을 다시 수행.
- 스태틱 멤버십은 대량 데이터 처리 시 효율적.
- 설정:
  - `group.instance.id`: 멤버 고유 ID
  - `session.timeout.ms`: 재시작 시 리밸런싱 시점 조정
- **관련 그림**:  
  - 그림 6-6, 6-7: 스태틱 멤버십 전/후 리밸런싱 변화



## ✅ 6.4 컨슈머 파티션 할당 전략

### 🔹 지원 전략과 특징 (표 6-1)

| 전략 | 설명 |
|||
| **Range** | 파티션을 순서대로 정렬해 컨슈머에 나눔. 일부 편중 가능 |
| **Round-Robin** | 모든 파티션을 순서대로 컨슈머에 돌아가며 균등 분배 |
| **Sticky** | 기존 파티션 할당을 최대한 유지 |
| **Cooperative Sticky** | Sticky + 일부만 재할당. EAGER보다 효율적 |

### 📌 주요 예시

- **Range**:  
  - 파티션을 순차적으로 나열해 순서대로 컨슈머에 할당  
  - 그림 6-8 참고

- **Round-Robin**:  
  - 모든 파티션을 순서대로 한 번씩 나열 후 컨슈머에 순환 배정  
  - 그림 6-9, 표 6-2 참고

- **Sticky**:  
  - 리밸런싱 발생 시 기존 할당 유지 최대화  
  - 그림 6-10 ~ 6-12 비교 예시

- **Cooperative Sticky**:  
  - 불필요한 전체 리밸런싱 방지, 일부만 재분배  
  - 그림 6-13 ~ 6-14 단계별 리밸런싱 과정  
  - 감지 → 중지 → 재시작으로 일부 파티션만 이동



## ✅ 6.5 정확히 한 번 컨슈머 동작

- 프로듀서 측은 트랜잭션 ID로 **정확히 한 번 전송(Exactly Once)**.
- 컨슈머 측은 메시지를 처리 후 오프셋을 commit → 중복 방지.
- `enable.idempotence` 옵션을 통해 중복 방지 기능 활성화.
- 예제 코드 실습:
  - 컨슈머가 정확히 한 번 읽기를 위해 필요한 설정과 동작 과정을 코드로 검증.



## ✨ 요약 흐름 핵심

1. **컨슈머의 안정성 핵심: 오프셋 관리**
2. 그룹 코디네이터가 멤버 상태 관리 & 리밸런싱 담당
3. **스태틱 멤버십 + 협력적 스티키 리밸런싱**으로 불필요한 리밸런싱 최소화
4. 할당 전략은 **Range, Round-Robin, Sticky, Cooperative Sticky**
5. **Exactly Once** 처리로 장애 복구 시 중복 처리 방지



## 📌 참고 개념

- **Heartbeat**: 컨슈머와 코디네이터 간 상태 확인용 신호
- **Session Timeout**: 하트비트를 받지 못하면 리밸런싱 발생
- **EAGER vs. COOPERATIVE**: 협력적(Cooperative)이 EAGER보다 중단과 리밸런싱 비용 낮춤



이상으로 Kafka 컨슈머 동작 원리와 리밸런싱, 할당 전략 전체 요약입니다. 🚀
